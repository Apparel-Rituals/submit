<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Uniform Request Form</title>
  <style>
    body { font-family: Arial; padding: 20px; max-width: 600px; margin: auto; }
    label { display: block; margin-top: 10px; }
    select, input[type="text"], input[type="number"] { width: 100%; padding: 8px; }
    #stockDisplay { margin: 5px 0; font-weight: bold; color: green; }
    button { margin-top: 15px; padding: 10px 20px; }
  </style>
</head>
<body>
  <h2>Uniform Request Form</h2>

  <form id="uniformForm">
    <label>Employee Name</label>
    <input type="text" id="empName" required>

    <label>Employee Code</label>
    <input type="text" id="empCode" required>

    <label>Uniform Barcode</label>
    <select id="barcode" required></select>
    <div id="stockDisplay"></div>

    <label>Quantity</label>
    <input type="number" id="qty" min="1" required>

    <label>Region</label>
    <select id="region" required></select>

    <label>Store</label>
    <select id="store" required></select>

    <button type="submit">Submit</button>
  </form>

  <div id="resultMsg" style="margin-top: 20px;"></div>

  <script>
    const stockURL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vST2H4FYdTFxPnJQq04pDiTtBA_8lDyJA_Ik7eKt6uVv9XwHTRwgs7UdoDBL_LBiJ6Iq2zZc-vK1BSx/pub?gid=901085179&single=true&output=csv'; // ← Public CSV link from Google Sheet
    const storeURL = 'store.json';   // ← store.json in same folder
    const scriptURL = 'https://script.google.com/macros/s/AKfycbyc22ExPknJN14z3CfYVn_PTlu_OacQfNmqeZsr50qeFrAKbnEHHaH7k5Rf22uWTdOX/exec'; // ← Google Apps Script Web App URL

    let stockMap = {};

    async function fetchStock() {
      const res = await fetch(stockURL);
      const csv = await res.text();
      const lines = csv.split('\n').slice(1); // skip header
      const barcodeSelect = document.getElementById('barcode');
      stockMap = {};

      barcodeSelect.innerHTML = '<option value="">--Select Barcode--</option>';
      lines.forEach(row => {
        const [barcode, qty] = row.split(',');
        if (barcode && qty) {
          stockMap[barcode.trim()] = parseInt(qty.trim());
          barcodeSelect.innerHTML += `<option value="${barcode.trim()}">${barcode.trim()}</option>`;
        }
      });

      barcodeSelect.addEventListener('change', () => {
        const selected = barcodeSelect.value;
        const stockQty = stockMap[selected] ?? 0;
        document.getElementById('stockDisplay').textContent = `Available: ${stockQty}`;
      });
    }

    async function fetchStores() {
      const res = await fetch(storeURL);
      const storeData = await res.json();
      const regionSelect = document.getElementById('region');
      const storeSelect = document.getElementById('store');

      regionSelect.innerHTML = '<option value="">--Select Region--</option>';
      for (let region in storeData) {
        regionSelect.innerHTML += `<option value="${region}">${region}</option>`;
      }

      regionSelect.addEventListener('change', () => {
        const selectedRegion = regionSelect.value;
        storeSelect.innerHTML = '';
        if (storeData[selectedRegion]) {
          storeData[selectedRegion].forEach(store => {
            storeSelect.innerHTML += `<option value="${store}">${store}</option>`;
          });
        }
      });
    }

    document.getElementById('uniformForm').addEventListener('submit', async (e) => {
      e.preventDefault();

      const barcode = document.getElementById('barcode').value;
      const qty = parseInt(document.getElementById('qty').value);
      const available = stockMap[barcode];

      if (qty > available) {
        alert('Requested quantity exceeds available stock.');
        return;
      }

      const data = {
        name: document.getElementById('empName').value,
        code: document.getElementById('empCode').value,
        barcode: barcode,
        qty: qty,
        region: document.getElementById('region').value,
        store: document.getElementById('store').value
      };

      try {
        const response = await fetch(scriptURL, {
          method: 'POST',
          mode: 'no-cors',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });

        document.getElementById('resultMsg').textContent = '✅ Submitted successfully!';
        fetchStock(); // Refresh stock live
        document.getElementById('uniformForm').reset();
        document.getElementById('stockDisplay').textContent = '';
      } catch (err) {
        document.getElementById('resultMsg').textContent = '❌ Submission failed.';
        console.error(err);
      }
    });

    document.addEventListener('DOMContentLoaded', () => {
      fetchStores();
      fetchStock();
    });
  </script>
</body>
</html>
