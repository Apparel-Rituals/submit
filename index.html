
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Uniform Request Form</title>
  <style>
    body { font-family: Arial; padding: 20px; background: #f5f5f5; }
    form { background: white; padding: 20px; border-radius: 8px; max-width: 500px; margin: auto; }
    label { display: block; margin-top: 15px; }
    select, input { width: 100%; padding: 8px; margin-top: 5px; }
    .stock-info { margin-top: 5px; font-size: 14px; color: green; }
    button { margin-top: 20px; padding: 10px; width: 100%; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer; }
  </style>
</head>
<body>
  <h2>Uniform Request Form</h2>
  <form id="uniformForm">
    <label>Employee Name</label>
    <input type="text" id="empName" required />

    <label>Employee Code</label>
    <input type="text" id="empCode" required />

    <label>Uniform Barcode</label>
    <select id="barcode" required></select>
    <div id="stockInfo" class="stock-info"></div>

    <label>Quantity</label>
    <input type="number" id="qty" required min="1" />

    <label>Region</label>
    <select id="region" required></select>

    <label>Store</label>
    <select id="store" required></select>

    <button type="submit">Submit</button>
  </form>

  <script>
    const stockURL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vST2H4FYdTFxPnJQq04pDiTtBA_8lDyJA_Ik7eKt6uVv9XwHTRwgs7UdoDBL_LBiJ6Iq2zZc-vK1BSx/pubhtml?gid=901085179&single=true';
    const storeURL = 'store.json';
    const submitURL = 'https://script.google.com/macros/s/AKfycbyc22ExPknJN14z3CfYVn_PTlu_OacQfNmqeZsr50qeFrAKbnEHHaH7k5Rf22uWTdOX/exec'; // Replace with actual

    let stockData = {};

    async function fetchStock() {
      const response = await fetch(stockURL);
      const text = await response.text();
      const rows = text.trim().split('\n').map(r => r.split(','));
      rows.slice(1).forEach(([barcode, stock]) => {
        stockData[barcode] = parseInt(stock);
      });
      const barcodeSelect = document.getElementById('barcode');
      barcodeSelect.innerHTML = '<option value="">--Select--</option>';
      for (let barcode in stockData) {
        barcodeSelect.innerHTML += `<option value="${barcode}">${barcode}</option>`;
      }
    }

    async function fetchStores() {
      const response = await fetch(storeURL);
      const storeData = await response.json();
      const regionSelect = document.getElementById('region');
      regionSelect.innerHTML = '<option value="">--Select Region--</option>';
      for (let region in storeData) {
        regionSelect.innerHTML += `<option value="${region}">${region}</option>`;
      }
      regionSelect.addEventListener('change', () => {
        const storeSelect = document.getElementById('store');
        const selectedRegion = regionSelect.value;
        storeSelect.innerHTML = '';
        storeData[selectedRegion].forEach(store => {
          storeSelect.innerHTML += `<option value="${store}">${store}</option>`;
        });
      });
    }

    document.getElementById('barcode').addEventListener('change', function () {
      const barcode = this.value;
      const stock = stockData[barcode] || 0;
      document.getElementById('stockInfo').textContent = `Available Stock: ${stock}`;
    });

    document.getElementById('uniformForm').addEventListener('submit', async function (e) {
      e.preventDefault();
      const empName = document.getElementById('empName').value;
      const empCode = document.getElementById('empCode').value;
      const barcode = document.getElementById('barcode').value;
      const qty = parseInt(document.getElementById('qty').value);
      const region = document.getElementById('region').value;
      const store = document.getElementById('store').value;
      const available = stockData[barcode] || 0;

      if (qty > available) {
        alert('Insufficient stock!');
        return;
      }

      const data = { empName, empCode, barcode, qty, region, store };
      const response = await fetch(submitURL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
      });
      const text = await response.text();
      alert(text.includes("Success") ? 'Form submitted!' : 'Error submitting form.');
      await fetchStock(); // Refresh stock
    });

    window.onload = async () => {
      await fetchStock();
      await fetchStores();
    };
  </script>
</body>
</html>
