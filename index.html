<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Uniform Request Form</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; max-width: 600px; margin: auto; }
    label { display: block; margin-top: 15px; }
    input, select, button { width: 100%; padding: 8px; margin-top: 5px; }
    #stockDisplay { font-weight: bold; margin-top: 5px; }
    .message { margin-top: 15px; padding: 10px; border-radius: 5px; }
    .success { background-color: #d4edda; color: #155724; }
    .error { background-color: #f8d7da; color: #721c24; }
  </style>
</head>
<body>
  <h2>Uniform Request Form</h2>
  <form id="uniformForm">
    <label for="empName">Employee Name</label>
    <input type="text" id="empName" required>

    <label for="empCode">Employee Code</label>
    <input type="text" id="empCode" required>

    <label for="barcode">Uniform Barcode</label>
    <select id="barcode" required></select>
    <div id="stockDisplay"></div>

    <label for="qty">Quantity</label>
    <input type="number" id="qty" min="1" required>

    <label for="region">Region</label>
    <select id="region" required></select>

    <label for="store">Store</label>
    <select id="store" required></select>

    <button type="submit">Submit</button>
  </form>

  <div id="message" class="message" style="display:none;"></div>

  <script>
    const submitURL = 'https://script.google.com/macros/s/AKfycbyc22ExPknJN14z3CfYVn_PTlu_OacQfNmqeZsr50qeFrAKbnEHHaH7k5Rf22uWTdOX/exec'; // üîÅ Replace this with your deployed Apps Script Web App URL

    let stockData = {};
    let storeData = {};

    async function loadStock() {
      const response = await fetch('stock.json');
      const data = await response.json();
      stockData = data;
      const barcodeSelect = document.getElementById('barcode');
      barcodeSelect.innerHTML = '';
      Object.entries(data).forEach(([barcode, stock]) => {
        const option = document.createElement('option');
        option.value = barcode;
        option.textContent = `${barcode}`;
        barcodeSelect.appendChild(option);
      });
      updateStockDisplay();
    }

    async function loadStores() {
      const response = await fetch('store.json');
      storeData = await response.json();
      const regionSelect = document.getElementById('region');
      regionSelect.innerHTML = '<option value="">Select Region</option>';
      Object.keys(storeData).forEach(region => {
        const option = document.createElement('option');
        option.value = region;
        option.textContent = region;
        regionSelect.appendChild(option);
      });
    }

    function updateStockDisplay() {
      const barcode = document.getElementById('barcode').value;
      const stock = stockData[barcode] || 0;
      document.getElementById('stockDisplay').textContent = `Available Stock: ${stock}`;
    }

    document.getElementById('barcode').addEventListener('change', updateStockDisplay);

    document.getElementById('region').addEventListener('change', () => {
      const region = document.getElementById('region').value;
      const storeSelect = document.getElementById('store');
      storeSelect.innerHTML = '<option value="">Select Store</option>';
      (storeData[region] || []).forEach(store => {
        const option = document.createElement('option');
        option.value = store;
        option.textContent = store;
        storeSelect.appendChild(option);
      });
    });

    document.getElementById('uniformForm').addEventListener('submit', async (e) => {
      e.preventDefault();

      const empName = document.getElementById('empName').value.trim();
      const empCode = document.getElementById('empCode').value.trim();
      const barcode = document.getElementById('barcode').value;
      const qty = parseInt(document.getElementById('qty').value);
      const region = document.getElementById('region').value;
      const store = document.getElementById('store').value;

      if (qty > (stockData[barcode] || 0)) {
        showMessage("‚ùå Not enough stock available.", true);
        return;
      }

      const payload = { empName, empCode, barcode, qty, region, store };

      try {
        const response = await fetch(submitURL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });

        const result = await response.text();
        if (response.ok && result === 'Success') {
          showMessage("‚úÖ Form submitted successfully!", false);
          stockData[barcode] -= qty; // Real-time stock update on page
          updateStockDisplay();
          document.getElementById('uniformForm').reset();
        } else {
          showMessage("‚ö†Ô∏è Error submitting the form.", true);
        }
      } catch (err) {
        showMessage("‚ö†Ô∏è Error submitting the form.", true);
        console.error(err);
      }
    });

    function showMessage(msg, isError) {
      const msgBox = document.getElementById('message');
      msgBox.textContent = msg;
      msgBox.className = `message ${isError ? 'error' : 'success'}`;
      msgBox.style.display = 'block';
    }

    loadStock();
    loadStores();
  </script>
</body>
</html>
